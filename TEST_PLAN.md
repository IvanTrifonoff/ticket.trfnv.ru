# TEST PLAN: Автоматическое тестирование функционала Pretix Seating

## I. Общие принципы тестирования

*   **Автоматизация:** Все тесты должны быть автоматизированы и интегрированы в CI/CD пайплайн.
*   **Изоляция:** Юнит-тесты проверяют компоненты изолированно.
*   **Покрытие:** Стремиться к высокому покрытию кода тестами.
*   **Воспроизводимость:** Тесты должны быть стабильными и давать одинаковый результат при каждом запуске.

## II. Юнит-тесты (Unit Tests)

### 1. Тесты `init_seating.py` (Backend)
*   **Цель:** Проверить корректность генерации данных и создания объектов Pretix.
*   **Сценарии:**
    *   **Структура JSON `layout_data`:**
        *   Проверить, что сгенерированный `layout_data` содержит поля `seat_guid`, `position` (с `x`, `y`) и `item_id` для каждого места.
        *   Убедиться, что количество зон, рядов и мест соответствует заданным параметрам.
    *   **Создание объектов `Seat`:**
        *   Выполнить `init_seating` и убедиться, что в базе данных созданы объекты `Seat` для всех мест схемы с корректными `seat_guid`, `event_id`, `product_id` и `blocked=False`.
        *   Проверить корректность `SeatCategoryMapping`.
    *   **Обработка существующих данных:**
        *   Тест на обновление существующей схемы без дублирования `Seat` объектов.

### 2. Тесты `seating.js` (Frontend - JavaScript)
*   **Цель:** Проверить корректность парсинга данных, отрисовки SVG и формирования запросов.
*   **Сценарии:**
    *   **Парсинг JSON:**
        *   Мокировать DOM и `<script type="application/json" id="seating-data">`. Проверить, что `seating.js` корректно парсит JSON и извлекает `layout_data`.
    *   **Рендеринг SVG:**
        *   Проверить, что на основе `layout_data` создаются SVG-элементы (`circle`, `text`) с правильными атрибутами (`cx`, `cy`, `r`, `fill`, `stroke`, `class`).
        *   Убедиться, что количество отрисованных мест соответствует данным.
    *   **Функция `addToCart`:**
        *   Мокировать `XMLHttpRequest`.
        *   Вызвать `addToCart` с тестовыми данными `seat`.
        *   Проверить, что:
            *   `FormData` содержит `csrfmiddlewaretoken`, `seat_<item_id>` с правильным `seat_guid`.
            *   `xhr.open` вызывается с `POST` методом и корректным URL `/cart/add`.
            *   Колбэки `xhr.onload` и `xhr.onerror` обрабатываются правильно (например, `window.location.reload()` вызывается при успехе, `alert()` при ошибке).

### 3. Тесты `seating.css` (Frontend - CSS)
*   **Цель:** Проверить, что стили применяются корректно и нет инлайн-стилей.
*   **Сценарии:**
    *   Использовать фреймворки типа `Playwright` или `Selenium` для загрузки страницы и проверки CSS-свойств элементов через инспекцию DOM.
    *   Проверить, что отсутствуют инлайн-стили для элементов схемы (кроме тех, что устанавливаются через JS для динамических позиций).
    *   Убедиться, что классы типа `.seat-circle` применяют ожидаемые стили.

## III. Интеграционные тесты (Integration Tests)

### 1. Взаимодействие Frontend (JS) и Backend (Cart API)
*   **Цель:** Проверить полный цикл добавления места в корзину через UI.
*   **Сценарии:**
    *   **Успешное добавление:**
        *   Использовать E2E-фреймворк (Playwright/Selenium) для навигации на страницу события.
        *   Кликнуть по доступному месту на схеме.
        *   Проверить, что место успешно добавлено в корзину (например, по изменению счетчика корзины, появлению места в списке корзины, или успешному перенаправлению/обновлению страницы).
    *   **Добавление занятого места:**
        *   Предварительно занять одно из мест (например, через прямое обращение к БД или через другой тестовый сценарий).
        *   Кликнуть по этому занятому месту.
        *   Проверить, что система выдает корректную ошибку ("Место уже занято", "Пожалуйста, выберите действительное место").
    *   **CSP-валидация:**
        *   Запустить тесты в браузере и убедиться, что в консоли нет ошибок CSP, связанных с нашим функционалом.

### 2. Валидация `init_seating.py` и Pretix Core Models
*   **Цель:** Проверить, что `init_seating` корректно настраивает базу данных Pretix для работы рассадки.
*   **Сценарии:**
    *   Запустить команду `pretix init_seating`.
    *   Используя Django ORM, проверить:
        *   Привязку `SeatingPlan` к `Event`.
        *   Наличие `SeatCategoryMapping`.
        *   Корректность данных в `Seat` объектах (GUID, продукт, блокировка).
        *   Доступность мест для продажи через стандартные API Pretix.

## IV. Сквозные тесты (End-to-End Tests)

### 1. Полный цикл продажи билета с рассадкой
*   **Цель:** Проверить весь пользовательский путь от выбора места до успешной оплаты и получения билета.
*   **Сценарии:**
    *   **Выбор и оплата:**
        *   E2E-фреймворк открывает страницу события, выбирает место.
        *   Добавляет место в корзину.
        *   Переходит к оформлению заказа, заполняет необходимые данные.
        *   Выбирает платежную систему (можно использовать мокированный шлюз для тестов).
        *   Завершает оплату.
        *   Проверяет, что заказ создан, место занято, а билет доступен.
    *   **Тестирование 54-ФЗ:**
        *   Интегрированные тесты для проверки отправки данных в тестовый ОФД (если есть возможность).

## V. Инструменты тестирования

*   **Python:** `unittest`, `pytest`, `Django Test Client` для бэкенд-юнит и интеграционных тестов.
*   **JavaScript:** `Jest`, `Vitest`, `React Testing Library` (если используется React) для фронтенд-юнит тестов.
*   **E2E:** `Playwright`, `Selenium`, `Cypress` для сквозного тестирования в реальных браузерах.
*   **CI/CD:** `GitHub Actions`, `GitLab CI`, `Jenkins` для автоматизации запуска тестов.

## VI. Дополнительные рекомендации

*   **Тестовая база данных:** Использовать отдельную, очищаемую базу данных для каждого тестового прогона.
*   **Фикстуры/Фабрики:** Использовать фикстуры Django или фабрики (например, `factory_boy`) для создания повторяемых тестовых данных.
*   **Тестирование производительности:** Для больших схем рассадки следует предусмотреть нагрузочные тесты.

---
**Версия:** 1.0
**Дата:** 2025-12-14
**Автор:** Gemini Agent
